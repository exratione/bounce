-- Summary --

The Bounce module collects non-delivery reports generated by remote mail
servers in response to emails sent from your Drupal site. It parses these
non-delivery reports for response codes, scores those codes, and blocks
further emails from being sent to email addresses that have passed a score
threshold. This helps prevent your site from looking like a spam source by
being a good internet citizen and respecting non-delivery responses, such
as a notice that a recipient email account no longer exists.

This module is a rewrite of non-Drupal code that itself resulted from some
years of experience running a few-thousand-subscriber mailing list
covering the sane end of a topic that, unfortunately, tends to trigger
spam filters - because there is a large and obnoxious spam-generating
industry over at the other, less sane end of the pool. The default
settings in Bounce are geared towards helping to maintain good long-term
deliverability of mail under that sort of circumstance.

Bounce employs a modular design in which the functionality necessary to
analyze and respond to non-delivery reports is split between Connector,
Analyst, and Blocker components. Default, working versions of these
components are provided, and developers can easily add other
implementations through hooks defined in this module.

-- Requirements --

You must have a mail account set up to receive non-delivery report emails.
e.g. automatic responses sent to the account bounces@mydomain.com. That
account must be accessible via POP or IMAP protocols from the server
hosting your Drupal site.

Ideally you should have your own mail server set up for your domain, and
be sending all outgoing mail from your Drupal site through that server via
a module such as SMTP Authentication Support. If you are not doing this,
then you have far more serious issues with mail deliverability than Bounce
can help you with.

-- Installation and Configuration --

Enable the Bounce module, then navigate to the module's configuration
page. On installation, default configuration is provided for all values
except:

- the mail server and account that will receive non-delivery reports
- the Return-Path header for outgoing mail

Enter these values and you are good to go. e.g. if your site is at
mydomain.com and you have a mailserver at mail.mydomain.com, then you
might set the following values in the General Settings page:

Return-Path header: bounce@mydomain.com

and the following values in the Connector settings page:

Server: mail.mydomain.com
Protocol: POP3S
Login: bounce
Password: my_obscure_password

Note that depending on your mailserver, login may be the account name
('bounce') or the full account email address ('bounce@mydomain.com').

-- How Bounce Marks and Blocks Addresses --

Bounce consists of three major component parts, the Connector, the
Analyst, and the Blocker:

1) On each cron run the Connector logs in to the Return-Path account and
retrieves mail items, the non-delivery reports, that it passes to the
Analyst.

2) The Analyst identifies the original recipient email address and assigns
a code to each non-delivery report.

3) Bounce then writes the codes, email addresses, and reports to the
database. The Blocker

4) The Blocker peruses the report records on each cron run. Every response
code is associated with a score, with higher scores indicating response
codes that more urgently require action. The Blocker checks to see whether
the sum of recorded scores for any particular email address exceeds a
threshold: those that do are marked and future delivery to these email
addresses is blocked.

Records of past non-delivery reports are cleared out when they become too
old, so an address will only be marked and blocked if it gains enough
non-delivery reports in a short enough time. The default settings for
Bounce will block email addresses fairly aggressively, reasoning that it
is better to deliver too few emails than to look like a spammer or a
mailbot by being non-responsive to non-delivery reports. This is not an
exact science by any means, and different content in mails will trigger
wildly different responses. If there is no big horrible spam-generating
industry spawning spam that shares topics with your site and its emails,
then you can probably set your score threshold higher than the default.

The scoring for specific codes, the threshold for marking emails, and the
age at which records of non-delivery reports are cleared out can all be
configured in the Bounce administration settings pages.

-- Return-Path Notes --

The Return-Path mail header set by Bounce is crucial to the operation of
this module: it is how you tell remote mail servers where you want
non-delivery reports sent to. If the Return-Path header is not set in the
outgoing emails sent by the server, then non-delivery report emails sent
back to you will most likely return directly to the sending account, which
in most circumstances is the site email address set in the administrative
interface. Bounce empties out the email account it is configured to
access, so you want it to have its own account for non-delivery reports.

Depending on how your Drupal instance is set up to send mail, the
Return-Path header set via Bounce may be overwritten or stripped by the
mail software on the server (e.g. sendmail) or by a mail server en route
to the final destination. Out of the box, a standard Drupal installation
sends mail from the local server using the PHP mail() function, which is
almost certainly going to see you losing the Return-Path. But then sending
from the local server rather than through a dedicated mail server will
cause you all sorts of other issues as well - such as being unable to
respond properly to greylisting, which is definitely going to make you
look like a spam source or mailbot. If you are serious about being a good
internet citizen when it comes to sending mail to your users, then you
really should set up a mail server and send your outgoing mail through
that server.

If you have a mail server set up, then install and configure the SMTP
Authentication Support module. This allows Drupal to send mail via your
mail server, and should preserve the Return-Path header set by Bounce. If
you're still losing the Return-Path header then the problem is a mail
server configuration issue, not a Drupal issue.

-- Use SMTP Authentication Support! Use a Mail Server! --

You should use the SMTP Authentication support module. You can use Bounce
without the SMTP Authentication Support module, but it's not a good idea
to do so unless you are using some other, equivelant module. You should
absolute, definitely, always be sending outgoing mail through a
full-featured mail server, and not via sendmail on the local web server.
In terms of looking like a spammer, the harm you do yourself by sending
from the local web server will likely outweigh most of what Bounce can do
for you. For example, not correctly handling greylisting is the sign of a
mailbot or compromised server, and that is exactly what will happen if you
send only via sendmail.

There are a range of other important topics relating to deliverability of
email and marking of servers as spam sources, such as the Sender Policy
Framework and other similar schemes, and you are encouraged to research
further.

-- Blocked Mails and Users --

Blocked mails are maintained independently of users. They are not deleted
when a user account is removed, and it is not necessary for a user account
to exist for a specific mail to be blocked.

The administrative settings for Bounce allow notifications to be set for
login, user account editing, password reset, and registration using
blocked email addresses: the general idea is to let the user know that he
or she will not receive mail rather than just silently failing.

-- Component Definition Hooks --

1) hook_bounce_connector()
2) hook_bounce_connector_alter(&$connectors)
3) hook_bounce_analyst()
4) hook_bounce_analyst_alter(&$analysts)
5) hook_bounce_blocker
6) hook_bounce_blocker_alter(&$analysts)

If you want to make available new components then you can create the
component and declare it as an option for use via implementations of these
hooks in your own module. Once declared, a component will show up as a
selectable option in the general settings administrative form.

-- Other Hooks --

1) hook_bounce_mails_blocked($mails)
2) hook_bounce_mails_unblocked($mails)

React to the blocking and unblocking of mails via these hooks.

3) hook_bounce_code_type()
4) hook_bounce_code_type_alter(&$types)

These fairly trivial hooks provide a list of different categories for the
response code that are assigned to non-delivery reports. The categories
have no material effect.

5) hook_bounce_analysis_alter(&$analysis, $report)

Use this hook to alter the analysis settled on for a particular
non-delivery report.
